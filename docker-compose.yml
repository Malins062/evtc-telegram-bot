version: "3.8"
services:

    evtc_bot:
        image: malins062/evtc-telegram-bot:latest
        container_name: evtc_bot
        restart: "always"
        stop_signal: SIGINT
        env_file:
            -  ./cfg/evtc-telegram-bot/.env
        depends_on:
            - redis

    redis:
        image: redis:latest
        container_name: redis-server
        restart: "always"
        volumes:
            - ./redisdata:/data
            - ./cfg/evtc-telegram-bot/redis.conf:/usr/local/etc/redis/redis.conf
        deploy:
            resources:
                limits:
                    cpus: '0.50'
                    memory: 512M
                reservations:
                    cpus: '0.25'
                    memory: 256M
        command: >
            sh -c '
              mkdir -p /usr/local/etc/redis &&
              redis-server /usr/local/etc/redis/redis.conf
            '
#        command: >
#            sh -c '
#              mkdir -p /usr/local/etc/redis &&
#              echo "bind 0.0.0.0" > /usr/local/etc/redis/redis.conf &&
#              echo "requirepass $REDIS_PASSWORD" >> /usr/local/etc/redis/redis.conf &&
#              echo "appendonly yes" >> /usr/local/etc/redis/redis.conf &&
#              echo "appendfsync everysec" >> /usr/local/etc/redis/redis.conf &&
#              echo "user default on nopass ~* +@all" > /usr/local/etc/redis/users.acl &&
#              echo "user $REDIS_USER on >$REDIS_USER_PASSWORD ~* +@all" >> /usr/local/etc/redis/users.acl &&
#              redis-server /usr/local/etc/redis/redis.conf --aclfile /usr/local/etc/redis/users.acl
#          '
        healthcheck:
#            test: ["CMD", "redis-cli", "-a", "$REDIS_PASSWORD", "ping"]
            test: ["CMD", "redis-cli", "ping"]
            interval: 30s
            timeout: 10s
            retries: 5
        tty: true
        stdin_open: true